<!DOCTYPE HTML>

<html>
<head>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">   
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="../../dist/charls-js.js"></script>
</head>
<body>
<div class="container">
    <div class="page-header">
        <h1>JpegLS Decoding with WASM</h1>
    </div>
    Width: <span id="width"></span>
    <p></p>
    Height: <span id="height"></span>
    <p></p>
    Bits Per Sample: <span id="bitsPerSample"></span>
    <p></p>
    Component Count:: <span id="componentCount"></span>
    <p></p>
    Decode Time: <span id="decodeTime">Calculating....</span>
</div>
</body>

<script>
    Module.onRuntimeInitialized = async _ => {

    // embind
    fetch('../../test/fixtures/CT2_JLSL-imageFrame-0.dat')
    //fetch('../../test/fixtures/MG.dat')
    .then((response) => {
      return response.arrayBuffer();
    })
    .then((arrayBuffer) => {
      const encodedBitStream = new Uint8Array(arrayBuffer);
      let instance = new Module.JpegLSDecode(encodedBitStream.length);
      const encodedBuffer = instance.getEncodedBuffer();
      encodedBuffer.set(encodedBitStream);

      setTimeout(() => {
        // do a "warm up" decode
        instance.decode();
        const frameInfo = instance.getFrameInfo();

        // update the UI with the frame info
        $('#width').text(''+frameInfo.width);
        $('#height').text(''+frameInfo.height);
        $('#bitsPerSample').text(''+frameInfo.bitsPerSample);
        $('#componentCount').text(''+frameInfo.componentCount);

        // now do the benchmark
        const iterations = 5;
        const begin = performance.now(); // performance.now() returns value in milliseconds
        for(var i=0; i < iterations; i++) {
          const begini = performance.now(); // performance.now() returns value in milliseconds
          instance.decode();
          const endi = performance.now();
          console.log((endi-begini) + " ms");
        }
        const end = performance.now();
        $('#decodeTime').text((end-begin) / iterations + ' ms');
        var decoded = instance.getDecodedBuffer();
        instance.delete();
      }, 1);
    });
  }
</script>
</html>
